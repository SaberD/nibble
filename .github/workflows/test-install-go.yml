name: Test Install via go install

on:
  workflow_dispatch:

jobs:
  go-install:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            arch: x64
            runs_on: ubuntu-24.04
          - os: ubuntu
            arch: arm64
            runs_on: ubuntu-24.04-arm
          - os: windows
            arch: x64
            runs_on: windows-2022
          - os: windows
            arch: arm64
            runs_on: windows-11-arm
          - os: macos
            arch: x64
            runs_on: macos-15-intel
          - os: macos
            arch: arm64
            runs_on: macos-15
    runs-on: ${{ matrix.runs_on }}
    steps:
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'

      - name: Configure isolated GOBIN (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          GOBIN_DIR="${RUNNER_TEMP}/go-bin-${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p "$GOBIN_DIR"
          echo "GOBIN=$GOBIN_DIR" >> "$GITHUB_ENV"
          echo "$GOBIN_DIR" >> "$GITHUB_PATH"

      - name: Configure isolated GOBIN (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $gobin = Join-Path $env:RUNNER_TEMP "go-bin-${{ matrix.os }}-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $gobin | Out-Null
          "GOBIN=$gobin" | Out-File -FilePath $env:GITHUB_ENV -Append
          $gobin | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Install nibble with go install
        run: go install github.com/backendsystems/nibble@latest

      - name: Smoke test nibble startup (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          log="${RUNNER_TEMP}/nibble-go.log"
          if script -q /dev/null bash -lc 'exit 0' >/dev/null 2>&1; then
            script -q /dev/null bash -lc 'NIBBLE_DEMO=1 nibble' >"$log" 2>&1 &
          else
            script -q -c 'NIBBLE_DEMO=1 nibble' /dev/null >"$log" 2>&1 &
          fi
          pid=$!
          sleep 3
          if ! kill -0 "$pid" 2>/dev/null; then
            cat "$log"
            exit 1
          fi
          kill "$pid" || true

      - name: Smoke test nibble startup (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:NIBBLE_DEMO = "1"
          $log = Join-Path $env:RUNNER_TEMP "nibble-go.log"
          $proc = Start-Process -FilePath "nibble" -RedirectStandardOutput $log -RedirectStandardError $log -PassThru
          Start-Sleep -Seconds 3
          if ($proc.HasExited) {
            if (Test-Path $log) { Get-Content $log }
            throw "nibble exited too early"
          }
          Stop-Process -Id $proc.Id -Force
